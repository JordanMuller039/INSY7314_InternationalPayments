# CircleCI Pipeline Configuration
# Automated testing and SonarQube code quality analysis

version: 2.1

orbs:
  node: circleci/node@5.1.0
  # TEMPORARILY DISABLED - Waiting for repo admin permissions
  # sonarcloud: sonarsource/sonarcloud@2.0.0

jobs:
  build-and-test:
    docker:
      - image: cimg/node:18.18
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}
            - v1-dependencies-
      
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm install
      
      - save_cache:
          paths:
            - backend/node_modules
          key: v1-dependencies-{{ checksum "backend/package-lock.json" }}
      
      - run:
          name: Run Security Tests
          command: |
            cd backend
            npm run test:security || true
      
      - run:
          name: Run API Tests
          command: |
            cd backend
            npm run test:api || true

  # TEMPORARILY DISABLED - Waiting for repo admin permissions
  # sonarqube-scan:
  #   docker:
  #     - image: cimg/node:18.18
  #   steps:
  #     - checkout
  #     
  #     - sonarcloud/scan:
  #         sonar_token_variable_name: SONAR_TOKEN

workflows:
  version: 2
  build-test-scan:
    jobs:
      - build-and-test
      # TEMPORARILY DISABLED - Waiting for repo admin permissions
      # - sonarqube-scan:
      #     context: sonarcloud
      #     requires:
      #       - build-and-test